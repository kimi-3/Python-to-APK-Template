name: Build Kivy Android APK In Debug Mode

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  checks: read

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64
  CYTHON_LANGUAGE_LEVEL: "3"

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 核心修正：删除 cache: 'pip'，解决找不到 requirements.txt 错误
    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update && sudo apt-get install -y \
          git zip unzip openjdk-17-jdk libltdl-dev \
          pkg-config zlib1g-dev libncurses5-dev cmake libffi-dev libssl-dev

    - name: Install Buildozer and core dependencies
      run: |
        python -m pip install --upgrade pip
        # 安装与 buildozer.spec 匹配的固定版本
        pip install buildozer==1.5.0 cython==0.29.33 \
          kivy==2.2.1 kivymd==1.2.0 paho-mqtt pyjnius setuptools
        pip install python-for-android==2023.07.05

    - name: Clean old build artifacts
      run: |
        rm -rf .buildozer/ bin/ build/ dist/ buildozer.log
        mkdir -p bin

    - name: Build APK (force disable AAB)
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        export BUILDOZER_ALLOW_PLATFORM_EXEC=1
        # 双重强制生成 APK，匹配修正后的 buildozer.spec
        buildozer -v android debug --set android.aab false 2>&1 | tee buildozer.log
        
        # 查找并复制所有构建产物（APK 优先，AAB 兜底）
        echo -e "\n=== 构建产物列表 ==="
        find . -name "*.apk" -o -name "*.aab" -type f
        find . -name "*.apk" -exec cp -f {} bin/ \;
        find . -name "*.aab" -exec cp -f {} bin/ \;

    - name: Check build result
      id: check-build
      run: |
        if ls bin/* 1> /dev/null 2>&1; then
          echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
          echo -e "\n=== 最终产物 ==="
          ls -la bin/
        else
          echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
          echo -e "\n=== 构建失败，最后100行错误日志 ==="
          cat buildozer.log | grep -i "error\|failed\|traceback\|exception" | tail -100
        fi

    - name: Upload build artifacts (APK/AAB)
      if: steps.check-build.outputs.BUILD_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: kivy-app-build
        path: bin/*
        retention-days: 30

    - name: Upload debug logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-debug-logs
        path: buildozer.log
        retention-days: 7
