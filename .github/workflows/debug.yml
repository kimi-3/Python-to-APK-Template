name: Build Kivy Android APK In Debug Mode

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  checks: read

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64
  CYTHON_LANGUAGE_LEVEL: "3"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.java-home=$JAVA_HOME -Dorg.gradle.jvmargs=-Xmx2048m"

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'  # 匹配Cython 0.29.33兼容版本

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            git zip unzip \
            python3-pip autoconf automake libtool \
            pkg-config zlib1g-dev libncurses5-dev \
            libncursesw5-dev cmake libffi-dev libssl-dev \
            curl unzip openjdk-17-jdk libltdl-dev
        # 安装依赖后清理缓存
        sudo apt-get clean

    - name: Install Buildozer and dependencies
      run: |
        python -m pip install --upgrade pip
        # 安装固定版本依赖（和buildozer.spec匹配）
        pip install buildozer cython==0.29.33 kivy==2.2.1 kivymd==1.2.0 paho-mqtt
        pip install python-for-android
        # 验证安装
        pip list | grep -E "buildozer|cython|kivy|kivymd"

    - name: Clean Buildozer cache (关键：避免旧配置干扰)
      run: |
        rm -rf .buildozer/ bin/ buildozer.spec~
        mkdir -p bin  # 确保bin目录存在

    - name: Build APK with Buildozer
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        # 打印环境信息，方便调试
        echo "=== 环境信息 ==="
        java -version
        python --version
        buildozer --version
        echo "ANDROID_HOME: $ANDROID_HOME"
        
        # 修正环境变量（原拼写错误）
        export BUILDOZER_ALLOW_PLATFORM_EXEC=1
        export USE_COLORS=0
        
        # 开始构建，输出详细日志
        echo "=== 开始构建APK ==="
        buildozer -v android debug 2>&1 | tee buildozer.log
        
        # 查找所有APK文件，打印路径（关键调试信息）
        echo "=== 查找APK文件 ==="
        find . -name "*.apk" -type f
        # 强制复制所有APK到bin目录（确保上传路径有文件）
        find . -name "*.apk" -exec cp -f {} bin/ \; 2>/dev/null || echo "未找到APK文件"

    - name: Check if APK was built
      id: check-build
      run: |
        # 检查bin目录下的APK
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "BUILD_FINAL_SUCCESS=true" >> $GITHUB_OUTPUT
          echo "=== 找到APK文件 ==="
          ls -la bin/*.apk
        else
          echo "BUILD_FINAL_SUCCESS=false" >> $GITHUB_OUTPUT
          echo "=== 未找到APK文件 ==="
          # 打印更多调试信息
          cat buildozer.log | grep -E "error|failed|apk|bin" | tail -50
        fi

    - name: Upload APK artifact
      if: steps.check-build.outputs.BUILD_FINAL_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: kivy-app-apk
        path: bin/*.apk  # 现在bin目录一定有APK（如果构建成功）
        retention-days: 30

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          buildozer.log
          .buildozer/android/platform/build-*/logs/*.log  # 补充Buildozer原生日志
        retention-days: 7
